<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Chess</title>
    <link rel="stylesheet" href="chess.css">
    <script src="chess.js"></script>
    <script src="https://unpkg.com/react@16/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
  </head>
  <body>

    <div id="errors" style="
      background: #c00;
      color: #fff;
      display: none;
      margin: -20px -20px 20px;
      padding: 20px;
      white-space: pre-wrap;
    "></div>

    <div id="root"></div>

    <script type="text/babel">
      
      window.addEventListener('mousedown', function(e) {
        document.body.classList.add('mouse-navigation');
        document.body.classList.remove('kbd-navigation');
      });
      window.addEventListener('keydown', function(e) {
        if (e.keyCode === 9) {
          document.body.classList.add('kbd-navigation');
          document.body.classList.remove('mouse-navigation');
        }
      });
      window.addEventListener('click', function(e) {
        if (e.target.tagName === 'A' && e.target.getAttribute('href') === '#') {
          e.preventDefault();
        }
      });
      window.onerror = function(message, source, line, col, error) {
        var text = error ? error.stack || error : message + ' (at ' + source + ':' + line + ':' + col + ')';
        errors.textContent += text + '\n';
        errors.style.display = '';
      };
      console.error = (function(old) {
        return function error() {
          errors.textContent += Array.prototype.slice.call(arguments).join(' ') + '\n';
          errors.style.display = '';
          old.apply(this, arguments);
        }
      })(console.error);

      // ##################################################
      // React components
      // ##################################################

      function Piece(props) {
        return (
          <div>
            <img src={Chess.findPieceImgName(props.type, props.color)} className="piece"/>
          </div>
        );
      }
      
      function Square(props) {
        const selected = props.isSelected ? " selected" : "";
        const value = props.value ? <Piece type={props.value.type} color={props.value.color} /> : props.value;
        return (
          <button className={"square" + selected} onClick={props.onClick}>
            {value}
          </button>
        );
      }

      class Board extends React.Component {
        renderSquare(i) {
          return (
            <Square
              value={this.props.squares[i]}
              key={"square-" + i}
              onClick={() => this.props.onClick(i)}
              isSelected={this.props.selectedSquare === i}
            />
          );
        }

        render() {
          const board = [];
          for (let row = 0; row < 8; row++) {
            let squares = [];
            for (let col = 0; col < 8; col++) {
              let squarePosition = row * 8 + col;
              squares.push(this.renderSquare(squarePosition));
            }
            board.push(
              <div className="board-row" key={"board-row-" + row}>
                {squares}
              </div>
            );
          }
          return (
            <div>
              {board}
            </div>
          );
        }
      }
      
      class Game extends React.Component {
        constructor() {
          super();
          const squares = Array(64).fill(null);
          squares[46] = new Chess.Piece(Chess.PieceTypeEnum.KING, Chess.ColorEnum.WHITE);
          squares[6] = new Chess.Piece(Chess.PieceTypeEnum.QUEEN, Chess.ColorEnum.WHITE);
          squares[35] = new Chess.Piece(Chess.PieceTypeEnum.BISHOP, Chess.ColorEnum.BLACK);
          squares[15] = new Chess.Piece(Chess.PieceTypeEnum.ROOK, Chess.ColorEnum.BLACK);
          squares[32] = new Chess.Piece(Chess.PieceTypeEnum.KING, Chess.ColorEnum.BLACK);

          this.state = {
            squares: squares,
            selectedSquare: null,
            currentPlayer: Chess.ColorEnum.WHITE,
          };
        }

        handleClick(i) {
          const squares = this.state.squares.slice();
          if (this.state.selectedSquare !== null) {
            if (Chess.isValidMove(this.state.selectedSquare, i, squares)) {
              // todo if opponent captured
              squares[i] = squares[this.state.selectedSquare];
              squares[this.state.selectedSquare] = null;
              this.setState({
                squares: squares,
                selectedSquare: null,
                currentPlayer: this.state.currentPlayer === Chess.ColorEnum.WHITE ? Chess.ColorEnum.BLACK : Chess.ColorEnum.WHITE,
              });
            } else {
              this.setState({
                selectedSquare: null,
              });
            }
          } else if (squares[i] && squares[i].color === this.state.currentPlayer) { // todo: if current color
            this.setState({
              selectedSquare: i,
            });
          }
          return;
        }

        render() {
          return (
            <div className="game">
              <div className="game-board">
                <Board
                  squares={this.state.squares}
                  onClick={i => this.handleClick(i)}
                  selectedSquare={this.state.selectedSquare}
                />
              </div>
              <div className="game-info">
                <div></div>
              </div>
            </div>
          );
        }
      }
      
      // ========================================
      
      ReactDOM.render(<Game />, document.getElementById("root"));
      

    </script>
  </body>
</html>
